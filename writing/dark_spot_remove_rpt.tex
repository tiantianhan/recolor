\documentclass[12pt, a4paper]{article}
\usepackage{array}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{etoolbox}
\usepackage{subcaption}
\usepackage{float}
\usepackage{amsmath}
\usepackage{mathtools}

\newcommand*\mean[1]{\bar{#1}}

\setlength{\parindent}{0em}
\setlength{\parskip}{1em}

\newcounter{rowcntr}[table]
\renewcommand{\therowcntr}{\thetable.\arabic{rowcntr}}
% A new columntype to apply automatic stepping
\newcolumntype{N}{>{\refstepcounter{rowcntr}\therowcntr}c}
% Reset the rowcntr counter at each new tabular
\AtBeginEnvironment{tabular}{\setcounter{rowcntr}{0}}

\begin{document}

\tableofcontents
\pagebreak

\listoffigures
\listoftables
\pagebreak

\section{Background and Literature Review}
\subsection{Survey of methods for changing and matching skin colour in Photoshop online}

The are a wide range of online video tutorials available for adjusting human skintone using Photoshop. The purposes of these videos include giving the subject of an image the appearance of a tan, matching the skintone of the subject to a desired skintone on another individual, or matching the skintone of a subjects face to the rest of the subject's body, which is often a slightly different colour. We surveyed a range of these videos and summarize the techniques of the most relevant videos with the most realistic results. In Appendix \ref{app:photoshop} are the detailed summary of three of these Photoshop processes.

\subsubsection{Summary of Photoshop techniques}

Levels and curves are frequently used for small brightness adjustments. For large brightness adjustments one technique was found (Appendix Source 1), where the skin area is brightened in a conversion to black and white, and then the luminosity blend mode is used to place the colour back into the image Sometimes highlights and shadows are adjusted separately, curves or the “blend if” function (which blends in an effect only if the pixel is above a certain threshold of brightness) can be used to achieve this effect.

There are many different methods to match colour, the colour may be adjusted separately from the brightness or simultaneously, often one would affect the other. Methods for matching colour include:
- Matching the ratios of C, M and Y by making adjustments with the selective colour tool
- Using curves or levels on individual colour channels, adjustments are made either by eye or to numerically match a target color

Often to reduce the vividness of the colour adjustments some adjustment to the saturation must be made.

Often the opacity of the overall effect is reduced for a more natural appearance.

\subsubsection{Limitations of Photoshop techniques}
Many adjustments are specific to each image and the specific, numerical amount of adjustment often have to be judged by eye

\subsubsection{Plausibility of reproducing the Photoshop effects in OpenCV for this project}
Many of the common techniques used could probably be reproduced. Specifically, the following can probably be reproduced since the math is understood and specific formulas can be found online: 
Effects involving levels and curves for adjusting both overall brightness and individual colour channels
Effects involving adjusting the HSV values
Effects involving the different blending modes and opacity 

There are however a few common effects used that seem like “black boxes” and might not be reproducible, more research is needed:
Recreating the effects achieved by using the Black and White adjustment layer
The selective colour tool

that have a similar purpose to this project and whose effects can plausibly be duplicated.

\pagebreak

\section{Methods}
To accomplish the objective of recolouring the skintone of a hand to a target colour, we wrote algorithms in C++ in Eclipse on OS X using OpenCV libraries. Eclipse is used to compile each iteration of the algorithm into an debug-mode excutable program named Recolor. For ease of testing, as the algorithm is modified, we add more functionality to the Recolor program and retain the ability to use previous versions of the algorithm. We use a custom Python script to run new versions of Recolor from the terminal to test it. All of the relevant code and its versions are hosted on a git repository at https://github.com/tiantianhan/recolor 

Recolor takes as input a hand image as well as a mask instructing it where to find the average skin colour of the hand, and a desired target skin colour. (Other flags and inputs are also used for testing purposes, see Appendix \ref{app:boost} for a full description of the usage.) Recolor then outputs the processed image where the skintone is adjusted to the target colour.

We iterated from simple to more complex algorithms, at each step testing the algorithm and evaluating the results. We tested progressive iterations on a set of hand images with varying skintones. The images are are shown in Figure \ref{img:input_hands_1}.

%all images that are not test results will be copied to the images folder

\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.20\textwidth}
        \includegraphics[width=\textwidth]{images/hand_dark}
        \caption{}\label{img:input_hands_1_dark}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.20\textwidth}
        \includegraphics[width=\textwidth]{images/hand_brown}
        \caption{}\label{img:input_hands_1_brown}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.20\textwidth}
        \includegraphics[width=\textwidth]{images/hand_light}
        \caption{}\label{img:input_hands_1_light}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.20\textwidth}
        \includegraphics[width=\textwidth]{images/hand_pale}
        \caption{}\label{img:input_hands_1_pale}
    \end{subfigure}
    \caption{Different hand images used for testing}\label{img:input_hands_1}
\end{figure}

 For each test, we called the Recolor program to transform the image of one hand to have the skintone of the hand in another image, then visually compared the processed image to the image of the target hand. We performed the process on all possible combinations of our test images, paying particular attention to the extreme cases, transforming from Figure \ref{img:input_hands_1_dark} to Figure \ref{img:input_hands_1_pale} and vice versa, as well as cases that start with a hand with midtone skin such as in Figure \ref{img:input_hands_1_brown} (as this is the most likely use case for applications that change a model's hand to match a range of skintones). We evaluated the resulting images subjectively, based on whether the processed hand looks believably like a hand naturally of that skintone, and noted any flaws that we then attempted to correct with the next iteration of the algorithm.

In the following subsections we summarize the results of each algorithm and our evaluation of the results.

\subsection{Simple brightness addition / subtraction}
\subsubsection{Algorithm}
To begin, we performed a simple addition of a value to each of the $rgb$ channels of the hand, such that the average colour of the hand in the processed image is equal to the average color of the hand in the target image. The algorithm is shown in Equation \ref{eq:boost_algo}.

\begin{equation} \label{eq:boost_algo}
r' = r + \delta_r
\end{equation}

Where 

\begin{equation*}
\delta_r = \mean{r_t} - \mean{r}
\end{equation*}

With the same equation applying for the $g$ and $b$ channels.

\subsubsection{Results}
The complete results are shown in Table \ref{tab:boost_test} in Appendix \ref{app:boost}, a portion is shown here for convenience.

\begin{longtable}{|c||c|c|c|}
    \caption*{Portion of test results of simple addition / subtraction brightening function from Table \ref{tab:boost_test} in the Appendix \ref{app:boost}}\\
    \hline
    No. & Original & Target & Results \\ 
      \hline  \ref{row:boost_test_hand_dark_to_hand_light} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_dark.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_light.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_boost_test/hand_dark_to_hand_light.jpg}
  \end{minipage} \\
    \hline  \ref{row:boost_test_hand_brown_to_hand_dark} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_dark.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_boost_test/hand_brown_to_hand_dark.jpg}
  \end{minipage} \\
\hline  \ref{row:boost_test_hand_brown_to_hand_light} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_light.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_boost_test/hand_brown_to_hand_light.jpg}
  \end{minipage} \\
  \hline  \ref{row:boost_test_hand_brown_to_hand_pale} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_pale.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_boost_test/hand_brown_to_hand_pale.jpg}
  \end{minipage} \\
    \hline
\end{longtable}

\subsubsection{Evaluation}
Images of darker skintones and smaller changes between the original skintone and target colour to begin with (Row \ref{row:boost_test_hand_brown_to_hand_dark}) tend to have better results than images with large changes, especially towards lighter colours. This is likely because large changes force bright points in the original image to be truncated at white, and also causes dark regions on the image, such as shadows and grooves, to become significantly brighter and less close to true black, giving the image a ``high-key" look (Row \ref{row:boost_test_hand_dark_to_hand_light} and \ref{row:boost_test_hand_brown_to_hand_light}).

In addition, we noted that at this stage the transformation from a dark coloured hand to a very pale hand, or even from a midtoned hand to a pale hand and vice versa is especially unconvincing. (Row \ref{row:boost_test_hand_brown_to_hand_pale}, also see \ref{row:boost_test_hand_dark_to_hand_pale} and \ref{row:boost_test_hand_pale_to_hand_dark})

\subsection{Proportional adjustment relative to average color}
\subsubsection{Algorithm}
To correct for the effect of the bright spots in the image image being over bright and the high-key appearance resulting from all the shadows being brightened, we used an algorithm that maps the black and white points of the image to the same value, and adjusts the colors in between to match the target average colour. The algorithm is shown in Equation \ref{eq:prop_algo}.

\begin{equation} \label{eq:prop_algo}
  r' = \left.
  \begin{dcases}
    \displaystyle \Big(\frac{\mean{r_t}}{\mean{r}}\Big)r, & \text{for } r \leq \mean{r} \\
    \displaystyle 255 - 
    \Big(\frac{255 - \mean{r_t}}{255 - \mean{r}}\Big)(255 - r), & \text{for } r > \mean{r} \\
  \end{dcases}
  \right.
\end{equation}

With the same equation applying for the $g$ and $b$ channels.

\subsubsection{Results}
The complete results are shown in Table \ref{tab:prop_test} in Appendix \ref{app:prop}, a portion is shown here for convenience.

\begin{longtable}{|c||c|c|c|}
    \caption*{Portion of test results of adjusting proportionally based on distance of color to the average from Table \ref{tab:prop_test} in the Appendix \ref{app:prop}}\\
    \hline
    No. & Original & Target & Results \\
    \hline  \ref{row:prop_test_hand_dark_to_hand_light} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_dark.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_light.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_proportional_test/hand_dark_to_hand_light.jpg}
  \end{minipage} \\
    \hline  \ref{row:prop_test_hand_brown_to_hand_dark} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_dark.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_proportional_test/hand_brown_to_hand_dark.jpg}
  \end{minipage} \\
\hline  \ref{row:prop_test_hand_brown_to_hand_light} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_light.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_proportional_test/hand_brown_to_hand_light.jpg}
  \end{minipage} \\
  \hline  \ref{row:prop_test_hand_brown_to_hand_pale} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_brown.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../inputs/hand_pale.jpg}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{../rc_test/outputs/20170516_boost_test/hand_brown_to_hand_pale.jpg}
  \end{minipage} \\
    \hline
\end{longtable}

\subsubsection{Evaluation}
This method improved the appearance of cases with over-bright spots or ``high-key" appearance issues, as Figure \ref{img:compare_bright_spot} shows:
\begin{figure}[H]
    \centering
    \begin{subfigure}[b]{0.40\textwidth}
        \includegraphics[width=\textwidth]{../rc_test/outputs/20170516_boost_test/hand_dark_to_hand_light.jpg}
        \caption{Simple brightening algorithm result}
    \end{subfigure}
    ~
    \begin{subfigure}[b]{0.40\textwidth}
        \includegraphics[width=\textwidth]{../rc_test/outputs/20170516_proportional_test/hand_dark_to_hand_light.jpg}
        \caption{Proportional adjustment algorithm result}
    \end{subfigure}
    \caption{Comparison of algorithm \ref{eq:boost_algo} and \ref{eq:prop_algo} results for transforming a dark hand (Figure \ref{img:input_hands_1_dark}) to a light hand (Figure \ref{img:input_hands_1_light}).\label{img:compare_bright_spot}}
\end{figure}

We noted however, that this method noticeably does not correct for, and even exacerbates slightly relative to algorithm \ref{eq:boost_algo}, the dark spots at the joints and creases of a hand of darker skintone when it is transformed to a lighter skintone (Row \ref{row:prop_test_hand_brown_to_hand_light}).

\subsection{Proportional brightening with dark spot correction}

\subsubsection{Algorithm}
We attempted to correct the dark spot issue by significantly reducing the absolute difference between dark pixels and the average colour, ensuring that the dark spots would instead have colours close to the average. We perform this correction on the output of the proportional adjustment algorithm.

\begin{equation} \label{eq:prop_algo}
  r'' = \left.
  \begin{dcases}
    \displaystyle \mean{r'} - \frac{(\mean{r'} - r')}{\alpha}, & \text{for } r' < \mean{r'} \\
    \displaystyle r', & \text{for } r' \geq \mean{r'} \\
  \end{dcases}
  \right.\\
\end{equation}

Where $\alpha$ is a constant, $\alpha  > 1$. The same equation applies for the $g$ and $b$ channels.

\subsubsection{Results}
See Table \ref{tab:prop_correct_test} in Appendix \ref{app:prop_corr_a10}, \ref{app:prop_corr_a5} and \ref{app:prop_corr_a3} for full results for a range of values for $\alpha$. %TODO

\subsubsection{Evaluation}
> there are improvements for dark spots for brown to light hand as expected\\
> particularly for large alpha, there is no true black in image, so same ``high-key" effect, possibly can get rid of with another curve or peicewise func instead of straight line?
> algorithm not meant to be used on light hand to dark hand - in fact an opposite effect should be used

\pagebreak

\appendix

\section{Summary of Photoshop techniques for changing skintone from select online video tutorials}
\subsection{How to Change a Person's Skin Color from Dark to Light in Photoshop}
\begin{longtable}{|c|c|}
    \caption{Results of }\\
    \hline
    Original & Results \\
    \hline
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/obama_orig}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/obama_res}
  \end{minipage} \\
    \hline
\end{longtable}
\pagebreak

\subsection{How to Change a Person's Skin Color from Dark to Light in Photoshop}
\begin{longtable}{|c||c|c|c|}
    \caption{Results of }\\
    \hline
    Original & Target & Results \\
    \hline
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/match_body_orig}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/match_body_targ}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/match_body_res}
  \end{minipage} \\
    \hline
\end{longtable}
\pagebreak

\subsection{How to Change a Person's Skin Color from Dark to Light in Photoshop}
\begin{longtable}{|c||c|c|c|}
    \caption{Results of }\\
    \hline
    No. & Original & Target & Results \\
    \hline  \ref{row:prop_test_hand_dark_to_hand_light} &
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/obama_orig}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/obama_orig}
  \end{minipage} & 
  \begin{minipage}{.29\textwidth}
    \includegraphics[width=\textwidth,height=\textheight,keepaspectratio]{images/obama_res}
  \end{minipage} \\
    \hline
\end{longtable}
\pagebreak

\section{Complete results for simple brightening}\label{app:boost}
\input{latex_maker/boost_test-summary}
\pagebreak

\section{Complete results for proportional adjustment}\label{app:prop}
\input{latex_maker/prop_test-summary}
\pagebreak

\section{Complete results for proportional adjustment with darkspot correction, $\alpha = 10$}\label{app:prop_corr_a10}
\input{latex_maker/prop_correct_test-summary}
\pagebreak

\section{Complete results for proportional adjustment with darkspot correction, $\alpha = 5$}\label{app:prop_corr_a5}
\input{latex_maker/prop_correct_test_a5-summary}
\pagebreak

\section{Complete results for proportional adjustment with darkspot correction, $\alpha = 3$}\label{app:prop_corr_a3}
\input{latex_maker/prop_correct_test_a3-summary}

\end{document}